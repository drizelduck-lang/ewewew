<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Result</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .status-pass { color: #155724; font-weight: bold; }
        .status-fail { color: #721c24; font-weight: bold; }
        
        .visual-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2em;
            margin-top: 2em;
        }
        .visual-column h3 {
            text-align: center;
            font-weight: 500;
            color: #333;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5em;
        }
        .analysis-image {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 1em;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .analysis-image:hover {
            opacity: 0.8;
        }
        .analysis-image-container {
            background-color: #fdfdfd;
            padding: 1em;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 1.5em;
        }
        .analysis-image-container p {
            text-align: center;
            font-weight: 600;
            color: var(--text-muted);
            margin: 0 0 0.5em 0;
        }
        
        /* Styles for analysis card */
        .analysis-card {
            background-color: #fdfdfd;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-top: 2em;
        }
        .analysis-card h3 {
            padding: 0.75em 1.25em;
            margin: 0;
            background-color: #f7f7f7;
            border-bottom: 1px solid var(--border-color);
        }
        .analysis-body {
            padding: 1.25em;
        }
        .analysis-final-result {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1em;
        }
        .analysis-note {
            font-style: italic;
            color: var(--text-muted);
            font-size: 0.9em;
            margin-bottom: 1.5em;
        }
        .analysis-list {
            list-style: none;
            padding-left: 0;
        }
        .analysis-list li {
            display: flex;
            justify-content: space-between;
            padding: 0.5em 0;
            border-bottom: 1px dashed #eee;
        }
        .analysis-list li span:first-child {
            font-weight: 500;
        }
        .analysis-list li span:last-child {
            font-family: monospace;
            font-size: 0.95em;
        }

        /* --- STYLE FOR HASHES --- */
        .record-value-hash {
            font-family: monospace;
            word-break: break-all;
            font-size: 0.9em;
        }

        /* --- Feature List Styles --- */
        .features-list {
            list-style: none;
            padding-left: 1em;
            margin: 0;
            font-family: "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.9em;
            line-height: 1.6;
            text-align: left;
        }
        .features-list li {
            white-space: nowrap;
        }
        .features-list li strong {
            color: var(--text-color);
            display: inline-block;
            width: 110px;
            font-weight: 500;
        }

        /* --- Modal Styles --- */
        #imageModal {
            display: none;
            position: fixed;
            z-index: 1000;
            padding-top: 50px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
        }
        #modalImage {
            margin: auto;
            display: block;
            width: auto;
            max-width: 90%;
            max-height: 90vh;
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .visual-comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Verification Result</h1>
        </header>
        
        <div class="card">
            {% if message %}
            <div class="result-message status-{{ status | default('warning') }}">
                {{ message }}
            </div>
            {% endif %}

            <!-- 
              START: IMAGE COMPARISON BLOCK
            -->
            {% if stored_image_filename and uploaded_image_filename %}
            <div class="visual-comparison">
                <div class="visual-column">
                    <h3>Original Registered Image</h3>
                    <div class="analysis-image-container">
                        <img src="{{ url_for('serve_upload', filename=stored_image_filename) }}" alt="Original Registered Image" class="analysis-image">
                    </div>
                </div>
                <div class="visual-column">
                    <h3>Uploaded Image for Verification</h3>
                    <div class="analysis-image-container">
                        <img src="{{ url_for('serve_upload', filename=uploaded_image_filename) }}" alt="Uploaded Image" class="analysis-image">
                    </div>
                </div>
            </div>
            {% endif %}
            <!-- END: IMAGE COMPARISON BLOCK -->


            <!-- 
              START: CHECK RESULTS BLOCK
            -->
            {% if check_results %}
            <div class="record-details">
                <h3>Integrity & Feature Checks</h3>

                <div class="record-item" style="margin-top: 1em;">
                    <span class="record-label">Biometric Key Check</span>
                    <span class="record-value {% if check_results.is_biokey_match %}status-pass{% else %}status-fail{% endif %}">
                        {% if check_results.is_biokey_match %}PASS{% else %}FAIL{% endif %}
                    </span>
                </div>
                <div class="record-item">
                    <span class="record-label" style="padding-left: 20px;">Stored Bio-Key:</span>
                    <span class="record-value record-value-hash">{{ record.bio_key }}</span>
                </div>
                <div class="record-item">
                    <span class="record-label" style="padding-left: 20px;">Calculated Bio-Key:</span>
                    <span class="record-value record-value-hash">{{ check_results.new_bio_key }}</span>
                </div>

                <div class="record-item" style="margin-top: 1em;">
                    <span class="record-label">Hybrid Hash Check</span>
                    <span class="record-value {% if check_results.is_hybrid_hash_match %}status-pass{% else %}status-fail{% endif %}">
                        {% if check_results.is_hybrid_hash_match %}PASS{% else %}FAIL{% endif %}
                    </span>
                </div>
                <div class="record-item">
                    <span class="record-label" style="padding-left: 20px;">Stored Hybrid Hash:</span>
                    <span class="record-value record-value-hash">{{ record.hybrid_hash }}</span>
                </div>
                <div class="record-item">
                    <span class="record-label" style="padding-left: 20px;">Calculated Hybrid Hash:</span>
                    <span class="record-value record-value-hash">{{ check_results.new_hybrid_hash }}</span>
                </div>
                <div class="record-item" style="margin-top: 1em;">
                    <span class="record-label">HMAC Integrity Check</span>
                    <span class="record-value {% if check_results.is_hmac_match %}status-pass{% else %}status-fail{% endif %}">
                        {% if check_results.is_hmac_match %}PASS{% else %}FAIL{% endif %}
                    </span>
                </div>
                <div class="record-item">
                    <span class="record-label" style="padding-left: 20px;">Stored HMAC:</span>
                    <span class="record-value record-value-hash">{{ record.hmac }}</span>
                </div>
                <div class="record-item">
                    <span class="record-label" style="padding-left: 20px;">Calculated HMAC:</span>
                    <span class="record-value record-value-hash">{{ check_results.new_hmac }}</span>
                </div>
                
            </div>
            {% endif %}
            
            <!-- END: CHECK RESULTS BLOCK -->

            <!-- Tamper Analysis Card -->
            {% if tamper_analysis %}
            <div class="analysis-card">
                <h3>Tamper Analysis</h3>
                <div class="analysis-body">
                    <div class="analysis-final-result">
                        Final Result: {{ tamper_analysis.final }}
                    </div>
                    {% if tamper_analysis.tamper_code %}
                    <div class="analysis-note">
                        Note: <strong>{{ tamper_analysis.note }}</strong> (Code: {{ tamper_analysis.tamper_code }})
                    </div>
                    {% else %}
                    <div class="analysis-note">
                        Note: {{ tamper_analysis.note }}
                    </div>
                    {% endif %}
                    
                    <strong>Top Candidates (Heuristic):</strong>
                    <ul class="analysis-list">
                        {% for name, score in tamper_analysis.top %}
                        <li><span>{{ name }}</span> <span>{{ "%.3f"|format(score) }}</span></li>
                        {% else %}
                        <li><span>No candidates found.</span> <span></span></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}


            <!-- 
              Visual Leaf/Analysis Comparison
            -->
            {% if stored_visuals and uploaded_visuals %}
            <div class="visual-comparison">
                <!-- Stored Column -->
                <div class="visual-column">
                    <h3>Stored Record Visuals</h3>
                    <div class="analysis-image-container">
                        <p>Leaf Pattern</p>
                        <img src="{{ url_for('static', filename=stored_visuals.leaf) }}" alt="Stored Leaf Pattern" class="analysis-image">
                    </div>
                    <div class="analysis-image-container">
                        <p>Fractal Analysis</p>
                        <img src="{{ url_for('static', filename=stored_visuals.fractal) }}" alt="Stored Fractal Analysis" class="analysis-image">
                    </div>
                    <div class="analysis-image-container">
                        <p>Skeleton Analysis</p>
                        <img src="{{ url_for('static', filename=stored_visuals.skeleton) }}" alt="Stored Skeleton Analysis" class="analysis-image">
                    </div>
                    <div class="analysis-image-container">
                        <p>DFT Analysis</p>
                        <img src="{{ url_for('static', filename=stored_visuals.dft) }}" alt="Stored DFT Analysis" class="analysis-image">
                    </div>
                </div>
                <!-- Uploaded Column -->
                <div class="visual-column">
                    <h3>Uploaded File Visuals</h3>
                    <div class="analysis-image-container">
                        <p>Leaf Pattern</p>
                        <img src="{{ url_for('static', filename=uploaded_visuals.leaf) }}" alt="Uploaded Leaf Pattern" class="analysis-image">
                    </div>
                    <div class="analysis-image-container">
                        <p>Fractal Analysis</p>
                        <img src="{{ url_for('static', filename=uploaded_visuals.fractal) }}" alt="Uploaded Fractal Analysis" class="analysis-image">
                    </div>
                    <div class="analysis-image-container">
                        <p>Skeleton Analysis</p>
                        <img src="{{ url_for('static', filename=uploaded_visuals.skeleton) }}" alt="Uploaded Skeleton Analysis" class="analysis-image">
                    </div>
                    <div class="analysis-image-container">
                        <p>DFT Analysis</p>
                        <img src="{{ url_for('static', filename=uploaded_visuals.dft) }}" alt="Uploaded DFT Analysis" class="analysis-image">
                    </div>
                </div>
            </div>
            {% elif stored_visuals %}
            <!-- This block shows on initial registration -->
            <div class="visual-comparison" style="grid-template-columns: 1fr;">
                <div class="visual-column">
                    <h3>Registered Visuals</h3>
                    <div class="analysis-image-container">
                        <p>Leaf Pattern</p>
                        <img src="{{ url_for('static', filename=stored_visuals.leaf) }}" alt="Stored Leaf Pattern" class="analysis-image">
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- 
              START: FEATURE COMPARISON BLOCK
            -->
            {% if check_results and record.features and check_results.new_features %}
            <div class="visual-comparison">
                <div class="visual-column">
                    <h3>Stored Features (Original)</h3>
                    <div class="analysis-image-container">
                        <ul class="features-list">
                        {% for key, val in record.features.items() %}
                            <li><strong>{{ key }}:</strong> <span>{{ val }}</span></li>
                        {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="visual-column">
                    <h3>Uploaded Features (Calculated)</h3>
                    <div class="analysis-image-container">
                        <ul class="features-list">
                        {% for key, val in check_results.new_features.items() %}
                            <li><strong>{{ key }}:</strong> <span>{{ val }}</span></li>
                        {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            {% endif %}
            <!-- END: FEATURE COMPARISON BLOCK -->


            <!-- 
              START: UPDATED STORED DB RECORD BLOCK 
            -->
            {% if record %}
                {% if check_results %}
                <!-- On VERIFY page, just show filenames -->
                <div class="record-details" style="margin-top: 2em;">
                    <h3>Stored Database Record</h3>
                    <div class="record-item">
                        <span class="record-label">Original Filename:</span>
                        <span class="record-value">{{ record.file_name }}</span>
                    </div>
                    
                </div>
                {% else %}
                <!-- On REGISTER page, show all details -->
                <div class="record-details" style="margin-top: 2em;">
                    <h3>Registered Record Details</h3>
                    <div class="record-item">
                        <span class="record-label">Original Filename:</span>
                        <span class="record-value">{{ record.file_name }}</span>
                    </div>
                    
                    <div class="record-item" style="margin-top: 1em;">
                        <span class="record-label">Bio-Key:</span>
                        <span class="record-value record-value-hash">{{ record.bio_key }}</span>
                    </div>
                    <!-- NEW ITEM -->
                    <div class="record-item">
                        <span class="record-label">Hybrid Hash:</span>
                        <span class="record-value record-value-hash">{{ record.hybrid_hash }}</span>
                    </div>
                    <!-- END NEW ITEM -->
                    <div class="record-item">
                        <span class="record-label">Salt:</span>
                        <span class="record-value record-value-hash">{{ record.salt }}</span>
                    </div>
                    <div class="record-item">
                        <span class="record-label">HMAC:</span>
                        <span class="record-value record-value-hash">{{ record.hmac }}</span>
                    </div>
                    <div class="record-item" style="margin-top: 1em; align-items: flex-start;">
                        <span class="record-label">Stored Features:</span>
                        <div class="record-value">
                            <ul class="features-list" style="padding-left: 0; margin-top: 0;">
                                {% for key, val in record.features.items() %}
                                    <li><strong>{{ key }}:</strong> <span>{{ val }}</span></li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endif %}
            <!-- END: UPDATED STORED DB RECORD BLOCK -->
            
            <a href="/" class="btn btn-secondary" style="margin-top: 2em;">Go Back Home</a>
        </div>
    </div>

    <!-- --- START: MODAL HTML --- -->
    <div id="imageModal">
        <span class="modal-close" id="modalClose">&times;</span>
        <img id="modalImage">
    </div>
    <!-- --- END: MODAL HTML --- -->

    <!-- --- START: JAVASCRIPT --- -->
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalClose = document.getElementById('modalClose');
            const images = document.querySelectorAll('.analysis-image');

            images.forEach(img => {
                img.addEventListener('click', function(e) {
                    const imgSrc = this.getAttribute('src');
                    modal.style.display = 'block';
                    modalImg.src = imgSrc;
                });
            });

            const closeModal = () => {
                modal.style.display = 'none';
            };

            modalClose.addEventListener('click', closeModal);
            
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });
        });
    </script>
    <!-- --- END: JAVASCRIPT --- -->

</body>
</html>